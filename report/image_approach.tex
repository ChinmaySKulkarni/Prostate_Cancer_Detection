\section{Classification Using Image-Level Features}
The patch-based approach to feature extraction failed to capture features that spanned multiple patches and which were representative of global characteristics of the images. 
In order to capture these characteristics, it was necessary to segment the images to separate out components that described the different histological objects (lumen, epithelial cells and stroma regions) more accurately. Once these components were extracted from each image, features specific to each component could then be constructed. We focused primarily on extracting features from the lumen and epithelial cell objects as they displayed the more variation with cancer malignancy as compared to the stroma region. We described the feature extraction methods employed to extract features based on lumen and epithelial objects in the following paragraphs.

\begin{figure}[!htb]
\centering
\includegraphics[scale=0.3]{figs/lumen_processing.png}
\caption{The different steps in segmentation of Lumen regions. (a) Original Image, (b) Lumen pixel inverse probabilities, (c) Candidate Lumen segmentation after thresholding and morphological processing of (b), (d) Final candidate lumen regions after discarding background regions.}
\label{fig:lumen_extraction_process}
\centering
\end{figure}



\subsection{Image Segmentation}

\subsubsection{Lumen Gland Segmentation}

In order to detect lumen glands from each image, we trained a k-Nearest Neighbors classifier on 1800 manually labelled pixels from three different histological object regions. This training set consisted of an equal number of pixels that belonged to either stroma, lumen glands or epithelial cells. For each pixel in the image, we found its nearest neighbors in the RGB color space. Based on the distance in the color space of each pixel's neighborhood from pixels corresponding to stroma and epithelial cells, we assigned a probability of belonging to stroma to each pixel. Pixels that had probabilities less than a threshold (0.2) were thus classified as being part of lumen glands and the resultant probability density images post-processed with morphological opening and closing operations to remove stray stray pixels to obtain binary images indicating whether a pixel belonged to a lumen gland or not. This approach also detected the edges of the image as lumen glands since they have similar color intensities as lumen objects. To avoid mistaking these regions as lumen regions, we processed the list of identified lumen regions to discard regions that have
an area larger than the a specified threshold. This threshold was calculated as the area left in an image
quadrant after subtracting the area occupied by a circle q
uadrant with radius equal to the half of the smaller image dimension (to approximate the area occupied by the tissue). Finally, the remaining connected components corresponding to the lumen glands were smoothed out through dilation using a disk structuring element. Figure \ref{fig:lumen_extraction_process} shows the various stages of output in the process.

\subsubsection{Epithelial Cell Segmentation}

We tried various approaches to extract pixels corresponding to epithelial cells. Initially, all the images were contrast enhanced (Figure \ref{fig:contrast_enhanced}) by clipping intensity values below a given threshold and increasing the pixel intensities of the resulting pixels. This helped to distinguish pixels corresponding to epithelial cells from the rest of the image since these pixels had predominantly higher pixel intensities. Once this pre-processing was done, we tried extracting epithelial cells using 3 different approaches (Figure \ref{fig:epithelial_process}).

\begin{figure}[!htb]
\centering
\includegraphics[scale=0.1]{figs/epithelial_contrast.png}
\caption{Contrast enhanced image for epithelial cell segmentation.}
\label{fig:contrast_enhanced}
\centering

\end{figure}

\begin{figure}[!htb]
\centering
\subfloat[LoG filtered image]{
	\includegraphics[scale=0.1]{figs/epithelial1a.png}
}
\hspace*{5mm}
\subfloat[Eipthelial cell locations extracted using local maxima (Zoom in to see epithelial cells)]{
	\includegraphics[scale=0.1]{figs/epithelial1b.png}
}
\\
\subfloat[K-means segmented image. Teal colored regions correspond to epithelial cells]{
	\includegraphics[scale=0.1]{figs/epithelial2a.png}
}
\hspace*{5mm}
\subfloat[Segmented epithelial cells from the K-means identified cluster]{
	\includegraphics[scale=0.1]{figs/epithelial2b.png}
}
\\
\subfloat[Epithelial cell locations identified by Hough Transform]{
	\includegraphics[scale=0.19]{figs/epithelial3a.png}
}
\hspace*{5mm}
\subfloat[Segmented epithelial cells from the Hough Transform locations]{
	\includegraphics[scale=0.1]{figs/epithelial3b.png}
}
\caption{Extraction of Epithelial cells using three different approaches.}
\label{fig:epithelial_process}
\centering
\end{figure}

\begin{enumerate}
\item \textbf{Local Minima Approach:}\\
We convolved the image with a Laplacian of Gaussian filter and observed high responses for regions corresponding to epithelial cells due to their circular shape. Subsequently, local maxima points were detected in a small window size for these high response pixels and only the largest response values were retained. The resulting binary image thus clearly segmented pixels corresponding to epithelial cells. The problem with this approach was that it failed to capture the connected components corresponding to epithelial cells and only represented these cells as single pixel responses. Two more approaches were thus tried which avoided this problem.

\item \textbf{K-Means Approach:}\\
In order to capture epithelial cells of varying sizes, Laplacian of Gaussian filters of different sizes were used. 8 different LoG filters (shown in Figure \ref{fig:log_filters8} of $\sigma$ and $3 \sigma$ for basic scales of $\sigma = \{\sqrt{2}, 2, 2\sqrt{2}, 4\}$ were used from the Leung-Malik Filter Bank \cite{lmfb}. On convolving the pre-processed images with these 8 LoG filters, we observed better detection of circular regions. In order to segment the epithelial cell regions from the rest of the histological objects, we represented each pixel as an 8-dimensional vector, comprising the responses from the 8 different LoG filters. K-means clustering was then applied on these images to separate out the different histological objects. We observed the most distinctive separation of clusters occurred for $K = 8$. This is intuitive since it was observed that images consisted of different pixel intensities for the following 8 regions in general:


\begin{enumerate}

\item Lumen regions.
\item Outer boundary of the epithelial cells (generally darker than the entire cell itself).
\item Inner parts of the epithelial cells.
\item Darker regions in the stroma which are located close to epithelial cells.
\item Image corners which are completely white.
\item Cytoplasm present inside lumen objects.
\item Darker staining of lumen objects along their gland walls.
\item Lighter staining of stroma cells in contact with the periphery of the image.

\end{enumerate}

Post-clustering, we had to automatically detect the cluster that corresponded to the segmented epithelial cells. We experimented with several approaches for doing this. After extracting the connected components associated with each cluster we performed morphological opening on them with a disk shaped structuring element of 2 pixel diameter to remove any small stray pixels. Following this, we used the following two metrics to extract the cluster corresponding to the segmentation of epithelial cells:

\begin{enumerate}
\item[1.] We selected the clusters with the smallest average connected component size as the cluster corresponding to epithelial cells. This approach correctly identified the epithelial cell cluster in 118 out of 149 images. 
\item[2.] Since epithelial cells are mostly circular or elliptical in shape, we selected the cluster with the largest percentage of elliptical connected components as the cluster corresponding to segmentation of epithelial cells. For this we fitted an ellipse to each connected component in each cluster and calculated the appropriate percentage for each cluster. This approach correctly identified the cluster corresponding to epithelial cells in 145 out of 149 images. We selected the results from this approach for further processing because of its better accuracy.
\end{enumerate}

\item \textbf{Hough Transform Approach:}\\
Finally, we also tried another approach to detecting epithelial cells which involved using the Hough Transform \cite{hough} for detecting circular objects in the pre-processed images. The hough transform is a technique for finding objects such as circles or lines in an image by means of a vote counting procedure in the parameter space of the equation describing the geometry of the object. To extract the circular regions corresponding to epithelial cells, we processed the images with hough transforms to find circles having radius between 3 and 6 pixels which corresponded to the approximate maximum and minimum epithelial cell sizes which we observed in our images. Once circle centers were detected, we convolved each binary image with a circular structuring element to represent the approximate shape of epithelial cells.

\end{enumerate}


\begin{figure}[!htb]
\includegraphics[width=\linewidth]{figs/lmf.png}
\caption{LoG filters of 8 different sizes from LM filter bank}
\label{fig:log_filters8}
\end{figure}



\subsection{Feature Extraction}
After having extracted the lumen and epithelial components for each image, we constructed features on these components. The final feature vector involved 10 features extracted from lumen glands and 2 features extracted from epithelial cells.

\subsubsection{Lumen-Based Features}
Lumen glands play a key role in distinguishing non-cancerous tissues from cancerous tissues. We have constructed 10 morphological features from the lumen glands that we detect from images.

\begin{enumerate}
\item \textbf{Lumen Area Ratio:} The percentage of pixels in the entire image that correspond to lumen glands as compared to the total number of pixels in the image. In non-cancerous tissues, lumen glands generally occupy a larger proportion of the image area than in cancerous tissues and this feature will help capture this property effectively.

\item \textbf{Number of Lumen Objects:} This feature captures the total number of connected components that correspond to lumen objects. Though the proportion of the image area that corresponds to lumen objects is higher in non-cancerous tissues, the number of such lumen objects is low as compared to images of cancerous tissues. In cancerous tissue images, lumen objects are broken up due to an explosive growth of epithelial cells and thus we would expect them to contain more number of lumen objects than images of non-cancerous tissues.

\item \textbf{Average and Variance in Lumen Size:} By providing a measure of how large the average lumen object is and how varied the sizes of lumen objects are, we can distinguish global-level features that capture the size of lumen objects in general. We would expect non-cancerous tissue images to have larger average size of lumen objects and also much larger variance in the size of lumen objects. In cancerous tissue images, lumen objects are generally of similar size and are smaller on an average.

\item \textbf{Average and Variance in Circularity of Lumen Objects:} The circularity of lumen objects capture how regularly shaped they are. Circularity is defined as:\\
\begin{align*}
C = \frac{P^2}{A}
\end{align*}
where $C$ is the circularity of a lumen object, $P$ is its perimeter and $A$ defines the area of the lumen object.
The circularity for an irregularly shaped object will be higher than that of a regularly shaped one.
The intuition behind keeping this feature is that non-cancerous tissues generally show more irregularly shaped lumen objects and thus, we expect that the average and variance in circularity of lumen objects for these images would be larger than the corresponding values for cancerous tissue images.

\item \textbf{Average and Variance in Eccentricity of Lumen Objects:} This feature would give higher values for images in which the lumen objects are more elliptical in shape. In images of cancerous tissues, since lumen objects are more circular in nature, we would expect this feature value to be low. For non-cancerous tissue images on the other hand, this feature value is expected to be high in general.

\item \textbf{Average and Variance in Distance from Centroid:} We calculate the average and variance in the distance of boundary pixels of lumen objects from the corresponding centroid of these lumen objects. This feature was included to capture the trend in radii values for all boundary pixels of lumen objects, rather than just the maximum and minimum radii (as have already been captured using eccentricity). Non-cancerous tissue images are expected to have higher values for this feature than cancerous tissue images.

\end{enumerate}

\subsubsection{Epithelial Cell-Based Features}
The extent of cancer progression in a prostate cancer tissue can be characterized by the proliferation of epithelial cells throughout the stroma. In cancerous tissues, epithelial cells generally penetrate lumen objects and multiply uncontrollably thus leading to higher density of epithelial cells. Contrastingly in non-cancerous tissues, epithelial cells generally line the lumen objects without puncturing them. In order to capture these properties, we constructed the following two features:

\begin{enumerate}
\item \textbf{Overall density of Epithelial cells in the tissue:} We calculated the ratio of number of connected components representing epithelial cells to the total area of the image. This gave us a good approximation of the density of epithelial cells in the image which is an important factor that distinguishes between benign and malignant tissue.

\item \textbf{Density of Epithelial cells in Lumen boundary regions:} We calculate this as the ratio of number of epithelial cells lying in a boundary region of upto 30 pixels around lumen objects and the area of the lumen boundary region. As explained previously, non-cancerous tissue images have a high density of epithelial cells along the lumen boundaries than cancerous tissue images. This feature gave us a good approximation of the density of epithelial cells around lumen objects.

\end{enumerate}

We thus obtained a 12-dimensional feature vector for each image example. Besides the above morphological features, we also tried using histogram-based features to capture color variations between cancerous and non-cancerous images. The intuition behind this was that in cancerous images, the color histogram should shift towards blue to account for a larger number of epithelial cells as compared to non-cancerous tissues. This distinction was not clearly observed in our images though, the reasons for which were twofold. Firstly, the color staining was not uniform for epithelial cells (the outer regions for cells were generally darker than the core areas), and many non-cancerous tissue images with a large number of lumen objects also had many epithelial cells around the boundaries of these lumen objects. We thus opted to exclude these features from our feature vector since they were unable to provide a good distinction between cancerous and non-cancerous tissue images.

\label{sec:image_based_approaches}